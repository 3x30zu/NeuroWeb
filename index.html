<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>NeuroWeb Шаблонный Редактор</title>
  <!-- GrapesJS -->
  <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/grapesjs"></script>
  <!-- Webpage Preset -->
  <link href="https://unpkg.com/grapesjs-preset-webpage/dist/grapesjs-preset-webpage.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/grapesjs-preset-webpage/dist/grapesjs-preset-webpage.min.js"></script>
  <style>
    /* Общие стили */
    body, html { margin: 0; padding: 0; height: 100%; display: flex; flex-direction: column; font-family: sans-serif; }
    header { background: #333; color: #fff; padding: 8px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    header h1 { font-size: 1rem; margin: 0; flex: 1 1 auto; }
    .controls { display: flex; gap: 8px; flex: 1 1 auto; justify-content: flex-end; }
    .controls input, .controls button { background: #555; color: #fff; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    #gjs { flex: 1; }

    /* Мобильная адаптация интерфейса GrapesJS */
    @media (max-width: 768px) {
      /* Панели инструментов внизу */
      .gjs-pn-views, .gjs-pn-panels.gjs-pn-panels {
        top: auto !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        height: auto !important;
        max-height: 150px;
        display: flex;
        flex-wrap: wrap;
        background: rgba(51,51,51,0.9);
        z-index: 9999;
      }
      /* Кнопки панели */
      .gjs-pn-panel .gjs-pn-btn {
        margin: 4px !important;
      }
      /* Басе-контейнер холста: отступ снизу для панели */
      .gjs-cv-canvas {
        padding-bottom: 160px !important;
      }
      /* Скрываем боковую панель инспектора для упрощения */
      .gjs-pn-views .gjs-pn-panels .gjs-pn-btn.fa-eye,  
      .gjs-pn-views .gjs-pn-panels .gjs-pn-btn.fa-desktop {
        display: none !important;
      }
      /* Уменьшаем заголовок */
      .gjs-cv-toolbar { display: none !important; }
    }
  </style>
</head>
<body>
  <header>
    <h1>NeuroWeb Редактор Шаблонов</h1>
    <div class="controls">
      <input type="file" id="templateLoader" accept=".html" title="Загрузить шаблон">
      <button id="exportBtn">Скачать HTML</button>
    </div>
  </header>
  <div id="gjs"></div>

  <script>
    let editor;
    document.getElementById('templateLoader').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      let inlineCss = '';
      doc.querySelectorAll('style').forEach(s => inlineCss += s.innerHTML);
      const cssLinks = Array.from(doc.querySelectorAll('link[rel="stylesheet"]')).map(l => l.href);

      if (editor) {
        editor.destroy();
        document.getElementById('gjs').innerHTML = '';
      }
      const customComponent = ed => {
        const dm = ed.DomComponents;
        const bm = ed.BlockManager;
        const btnType = dm.getType('button');
        if (btnType) {
          btnType.model.prototype.defaults.draggable = '*';
          btnType.model.prototype.defaults.droppable = '*';
        }
        bm.add('new-button', {
          label: 'Новая кнопка',
          category: 'Элементы',
          attributes: { class: 'fa fa-hand-pointer' },
          content: `<button class="btn">Новая кнопка</button>`,
        });
      };

      editor = grapesjs.init({
        container: '#gjs',
        fromElement: false,
        height: '100%',
        storageManager: false,
        plugins: ['gjs-preset-webpage', customComponent],
        pluginsOpts: { 'gjs-preset-webpage': {} },
        canvas: {
          styles: cssLinks.concat([`body{max-width:1200px;margin:0 auto;}`]),
          scripts: []
        },
        components: doc.body.innerHTML,
        style: inlineCss
      });
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      if (!editor) return alert('Сначала загрузите шаблон!');
      const html = editor.getHtml();
      const css = editor.getCss();
      const full = `<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>Edited Template</title>\n<style>\n${css}\n</style>\n</head>\n<body>\n${html}\n</body>\n</html>`;
      const blob = new Blob([full], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'edited_template.html';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
