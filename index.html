<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>NeuroWeb Шаблонный Редактор</title>
  <!-- GrapesJS -->
  <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/grapesjs"></script>
  <!-- Webpage Preset -->
  <link href="https://unpkg.com/grapesjs-preset-webpage/dist/grapesjs-preset-webpage.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/grapesjs-preset-webpage/dist/grapesjs-preset-webpage.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; display: flex; flex-direction: column; font-family: sans-serif; }
    header { background: #333; color: #fff; padding: 10px; display: flex; align-items: center; justify-content: space-between; }
    header h1 { font-size: 1.2rem; margin: 0; }
    .controls { display: flex; gap: 10px; }
    .controls input, .controls button { background: #555; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    #gjs { flex: 1; }
    @media (max-width: 768px) {
      header { flex-direction: column; align-items: stretch; }
      header h1 { text-align: center; margin-bottom: 8px; }
      .controls { justify-content: center; flex-wrap: wrap; }
      .controls input, .controls button { flex: 1 1 45%; margin: 4px; font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>NeuroWeb Редактор Шаблонов</h1>
    <div class="controls">
      <input type="file" id="templateLoader" accept=".html">
      <button id="exportBtn">Скачать HTML</button>
    </div>
  </header>
  <div id="gjs"></div>

  <script>
    let editor;

    document.getElementById('templateLoader').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      let inlineCss = '';
      doc.querySelectorAll('style').forEach(s => inlineCss += s.innerHTML);
      const cssLinks = Array.from(doc.querySelectorAll('link[rel="stylesheet"]')).map(l => l.href);

      if (editor) {
        editor.destroy();
        document.getElementById('gjs').innerHTML = '';
      }
      const customComponent = ed => {
        const dm = ed.DomComponents;
        const bm = ed.BlockManager;
        const btnType = dm.getType('button');
        if (btnType) {
          btnType.model.prototype.defaults.draggable = '*';
          btnType.model.prototype.defaults.droppable = '*';
        }
        bm.add('new-button', {
          label: 'Новая кнопка',
          category: 'Элементы',
          content: `<button class="btn">Новая кнопка</button>`,
        });
      };

      editor = grapesjs.init({
        container: '#gjs',
        fromElement: false,
        height: '100%',
        storageManager: false,
        plugins: ['gjs-preset-webpage', customComponent],
        pluginsOpts: { 'gjs-preset-webpage': {} },
        canvas: {
          styles: cssLinks.concat([`body{max-width:1200px;margin:0 auto;}`]),
          scripts: []
        },
        components: doc.body.innerHTML,
        style: inlineCss
      });
    });

    document.getElementById('exportBtn').addEventListener('click', async () => {
      if (!editor) return alert('Сначала загрузите шаблон!');
      const html = editor.getHtml();
      const css = editor.getCss();
      const full = `<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>index.html</title>\n<style>\n${css}\n</style>\n</head>\n<body>\n${html}\n</body>\n</html>`;
      // Используем File System Access API, если доступен
      if (window.showSaveFilePicker) {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName: 'index.html',
            types: [{ description: 'HTML Files', accept: { 'text/html': ['.html'] } }]
          });
          const writable = await handle.createWritable();
          await writable.write(full);
          await writable.close();
        } catch (err) {
          alert('Сохранение отменено или ошибка: ' + err);
        }
      } else {
        // fallback: открываем диалог сохранения через ссылку
        const blob = new Blob([full], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'index.html';
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }
    });
  </script>
</body>
</html>
